# .github/workflows/frontend-deploy.yml

name: Build and Deploy Frontend to Azure Static Web Apps

on:
  push:
    branches:
      - main
    # Optional: Only trigger if files in the frontend app or shared libs change
    # paths:
    #  - 'apps/vinylplatz-web/**'
    #  - 'libs/**' # Adjust if you have relevant shared libs
    #  - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

jobs:
  build_and_deploy_frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required for checkout

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true # Checkout submodules if any

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install Root Dependencies
        run: npm install # Installs all monorepo dependencies

      # --- Build the Frontend Application ---
      - name: Build vinylplatz-web application
        run: npx nx build vinylplatz-web --configuration=production # Use Nx to build the frontend

      # --- Deploy to Azure Static Web Apps ---
      - name: Deploy to Azure Static Web App
        id: deploy-static-app
        uses: Azure/static-web-apps-deploy@v1
        with:
          # Required: The deployment token from Azure Static Web Apps resource
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload" # Specify that we are uploading pre-built files
          # Required: Path to the folder containing the built application files
          # Should match the outDir in apps/vinylplatz-web/vite.config.ts
          app_location: "dist/apps/vinylplatz-web"
          api_location: "" # Leave blank, API is hosted elsewhere
          output_location: "" # Leave blank, app_location is the output dir
